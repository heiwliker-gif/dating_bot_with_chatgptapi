<script>
    // ==========================================================
    // JS LOGIC (–° –ò–ù–¢–ï–ì–†–ê–¶–ò–ï–ô CHATGPT)
    // ==========================================================

    // üî¥ –í–ê–ñ–ù–û: –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –°–í–û–ô –ö–õ–Æ–ß API OPENAI (sk-...)
    const OPENAI_API_KEY = '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'; 

    const i18n = {
      ru: {
        nav_search: '–ü–æ–∏—Å–∫', nav_chats: '–ß–∞—Ç—ã', nav_gifts: '–ü–æ–¥–∞—Ä–∫–∏', nav_profile: '–ü—Ä–æ—Ñ–∏–ª—å',
        stats: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', views: '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã', likes: '–õ–∞–π–∫–∏', ai: 'AI Score', verified: '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è',
        realtime: 'Real-time', simulate: '–°–∏–º—É–ª—è—Ü–∏—è –º–∞—Ç—á–∞', all_cities: '–í—Å–µ –≥–æ—Ä–æ–¥–∞',
        your_matches: '–í–∞—à–∏ –º–∞—Ç—á–∏', gift_shop: '–ú–∞–≥–∞–∑–∏–Ω –ø–æ–¥–∞—Ä–∫–æ–≤', online: '–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å',
        your_name: '–í–∞—à–µ –∏–º—è', your_city: '–í–∞—à –≥–æ—Ä–æ–¥', choose_city: '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥',
        interests_label: '–ò–Ω—Ç–µ—Ä–µ—Å—ã', upload_photo: '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ', photo_hint: '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞',
        save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', verify: '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è', choose_gift: '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∞—Ä–æ–∫',
        toast_saved: '–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω', toast_verified: '–ü—Ä–æ—Ñ–∏–ª—å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω ‚úì',
        toast_like: '–õ–∞–π–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚ù§Ô∏è', toast_skip: '–ü—Ä–æ–ø—É—Å–∫', toast_super: '–°—É–ø–µ—Ä–ª–∞–π–∫ ‚≠ê',
        toast_gift: '–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω üéÅ', toast_match: '–ù–æ–≤—ã–π –º–∞—Ç—á! üíò',
        chat_placeholder: '–°–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶', rt_new_match: '–ù–æ–≤—ã–π –º–∞—Ç—á', rt_open_chat: '–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç', rt_close: '–ó–∞–∫—Ä—ã—Ç—å',
        cat_music: 'üéµ –ú—É–∑—ã–∫–∞', cat_sport: 'üèÄ –°–ø–æ—Ä—Ç', cat_travel: '‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', cat_gaming: 'üéÆ –ì–µ–π–º–∏–Ω–≥',
        cat_art: 'üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ', cat_cooking: 'üç≥ –ì–æ—Ç–æ–≤–∫–∞', cat_movies: 'üé¨ –ö–∏–Ω–æ', cat_tech: 'üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', cat_nature: 'üçÉ –ü—Ä–∏—Ä–æ–¥–∞'
      },
      kz: {
        nav_search: '–Ü–∑–¥–µ—É', nav_chats: '–ß–∞—Ç—Ç–∞—Ä', nav_gifts: '–°—ã–π–ª—ã“õ—Ç–∞—Ä', nav_profile: '–ü—Ä–æ—Ñ–∏–ª—å',
        stats: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', views: '–ö”©—Ä—É–ª–µ—Ä', likes: '“∞–Ω–∞—Ç“õ–∞–Ω–¥–∞—Ä', ai: 'AI Score', verified: '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è',
        realtime: 'Real-time', simulate: '–ú–∞—Ç—á —Å–∏–º—É–ª—è—Ü–∏—è—Å—ã', all_cities: '–ë–∞—Ä–ª—ã“õ “õ–∞–ª–∞–ª–∞—Ä',
        your_matches: '–°—ñ–∑–¥—ñ“£ –º–∞—Ç—á—Ç–∞—Ä', gift_shop: '–°—ã–π–ª—ã“õ –¥“Ø–∫–µ–Ω—ñ', online: '“ö–∞–∑—ñ—Ä –æ–Ω–ª–∞–π–Ω',
        your_name: '–ê—Ç—ã“£—ã–∑', your_city: '“ö–∞–ª–∞“£—ã–∑', choose_city: '“ö–∞–ª–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑',
        interests_label: '“ö—ã–∑—ã“ì—É—à—ã–ª—ã“õ—Ç–∞—Ä', upload_photo: '–§–æ—Ç–æ –∂“Ø–∫—Ç–µ—É', photo_hint: '–¢–∞“£–¥–∞—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑',
        save: '–°–∞“õ—Ç–∞—É', verify: '–ü—Ä–æ—Ñ–∏–ª—å–¥—ñ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è–ª–∞—É', choose_gift: '–°—ã–π–ª—ã“õ —Ç–∞“£–¥–∞“£—ã–∑',
        toast_saved: '–ü—Ä–æ—Ñ–∏–ª—å —Å–∞“õ—Ç–∞–ª–¥—ã', toast_verified: '–ü—Ä–æ—Ñ–∏–ª—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è–¥–∞–Ω ”©—Ç—Ç—ñ ‚úì',
        toast_like: '–õ–∞–π–∫ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ ‚ù§Ô∏è', toast_skip: '”®—Ç–∫—ñ–∑—É', toast_super: '–°—É–ø–µ—Ä–ª–∞–π–∫ ‚≠ê',
        toast_gift: '–°—ã–π–ª—ã“õ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ üéÅ', toast_match: '–ñ–∞“£–∞ –º–∞—Ç—á! üíò',
        chat_placeholder: '–•–∞–±–∞—Ä–ª–∞–º–∞‚Ä¶', rt_new_match: '–ñ–∞“£–∞ –º–∞—Ç—á', rt_open_chat: '–ß–∞—Ç—Ç—ã –∞—à—É', rt_close: '–ñ–∞–±—É',
        cat_music: 'üéµ –ú—É–∑—ã–∫–∞', cat_sport: 'üèÄ –°–ø–æ—Ä—Ç', cat_travel: '‚úàÔ∏è –°–∞—è—Ö–∞—Ç', cat_gaming: 'üéÆ –û–π—ã–Ω–¥–∞—Ä',
        cat_art: 'üé® ”®–Ω–µ—Ä', cat_cooking: 'üç≥ –ê—Å–ø–∞–∑–¥—ã“õ', cat_movies: 'üé¨ –ö–∏–Ω–æ', cat_tech: 'üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è', cat_nature: 'üçÉ –¢–∞–±–∏“ì–∞—Ç'
      }
    };

    const photoGradients = [
      'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
      'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
      'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)'
    ];

    const profileDatabase = [
      { 
        id: 101, name: '–¢—É—Ä–∞—à –ê–ª–∏', age: 23, city: '–ê–ª–º–∞—Ç—ã', emoji: 'ü¶Å', 
        image: 'https://raw.githubusercontent.com/dreamnewly/dating-bot-photos-demo/main/image%20(2).png', 
        bio: 'üí° AI-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Ç–µ–ø–µ—Ä—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ –≤–∞—à–∏–º –æ–±—â–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–∞–º! –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ. üòé', 
        interests: ['üèÄ –°–ø–æ—Ä—Ç', '‚úàÔ∏è –°–∞—è—Ö–∞—Ç', 'üíº –ë–∏–∑–Ω–µ—Å'], verified: true, online: true, aiScore: 98, photos: [0] 
      },
      { 
        id: 102, name: '–ú–∏—Ä–∞—Å –ù—É—Ä–∫–∞—Å—ã–º', age: 24, city: '–ê—Å—Ç–∞–Ω–∞', emoji: 'üòé',
        image: 'https://raw.githubusercontent.com/dreamnewly/dating-bot-photos-demo/main/photo_5192685967507132795_x.png', 
        bio: '–õ—é–±–ª—é IT, —Å—Ç–∞—Ä—Ç–∞–ø—ã –∏ –≤–∫—É—Å–Ω—ã–π –∫–æ—Ñ–µ. –ò—â—É —Ç—É —Å–∞–º—É—é.', 
        interests: ['üíª –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', '‚òï –ö–æ—Ñ–µ', 'üéÆ –ì–µ–π–º–∏–Ω–≥'], verified: true, online: false, aiScore: 95, photos: [1] 
      },
      { 
        id: 103, name: '–û—Ä–∞–∑–±–∞–∫–æ–≤ –¢–µ–º–∏—Ä–ª–∞–Ω', age: 22, city: '–ê–ª–º–∞—Ç—ã', emoji: 'üî•',
        image: 'https://raw.githubusercontent.com/dreamnewly/dating-bot-photos-demo/main/photo_5440511241249473687_c.png', 
        bio: '–í—Å–µ–≥–¥–∞ –Ω–∞ –ø–æ–∑–∏—Ç–∏–≤–µ. –õ—é–±–ª—é –≥–æ—Ä—ã –∏ –∞–∫—Ç–∏–≤–Ω—ã–π –æ—Ç–¥—ã—Ö üèîÔ∏è', 
        interests: ['üèîÔ∏è –ì–æ—Ä—ã', 'üéµ –ú—É–∑—ã–∫–∞', 'üöó –ê–≤—Ç–æ'], verified: true, online: true, aiScore: 92, photos: [2] 
      },
      { 
        id: 104, name: '–ö–∞–∑–±–µ–∫–æ–≤–∞ –ê–π–≥–µ—Ä–∏–º', age: 21, city: '–ê–ª–º–∞—Ç—ã', emoji: 'üå∏',
        image: 'https://raw.githubusercontent.com/dreamnewly/dating-bot-photos-demo/main/photo_5192685967507132809_x.png', 
        bio: '–ù–µ–∂–Ω–∞—è, –Ω–æ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º. –õ—é–±–ª—é –∏—Å–∫—É—Å—Å—Ç–≤–æ –∏ –∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç—å ‚ú®', 
        interests: ['üé® –ò—Å–∫—É—Å—Å—Ç–≤–æ', 'üëó –ú–æ–¥–∞', 'üìö –ö–Ω–∏–≥–∏'], verified: true, online: true, aiScore: 99, photos: [3] 
      },
      { 
        id: 105, name: '–ñ–∞–Ω–∏—è', age: 20, city: '–®—ã–º–∫–µ–Ω—Ç', emoji: 'üíÉ',
        image: 'https://raw.githubusercontent.com/dreamnewly/dating-bot-photos-demo/main/photo_5192685967507132803_m.png', 
        bio: '–£–ª—ã–±–∞–π—Å—è, —Ç–µ–±–µ —ç—Ç–æ –∏–¥–µ—Ç! –õ—é–±–ª—é —Ç–∞–Ω—Ü—ã –∏ –ª–µ—Ç–æ ‚òÄÔ∏è', 
        interests: ['üíÉ –¢–∞–Ω—Ü—ã', 'üé¨ –ö–∏–Ω–æ', 'üç≥ –ì–æ—Ç–æ–≤–∫–∞'], verified: false, online: true, aiScore: 89, photos: [4] 
      }
    ];

    const gifts = [
      { nameKz: '–†–∞—É—à–∞–Ω', nameRu: '–†–æ–∑–∞', emoji: 'üåπ', cost: 10 },
      { nameKz: '–®–æ–∫–æ–ª–∞–¥', nameRu: '–®–æ–∫–æ–ª–∞–¥', emoji: 'üç´', cost: 15 },
      { nameKz: '–¢”ô–∂', nameRu: '–ö–æ—Ä–æ–Ω–∞', emoji: 'üëë', cost: 50 },
      { nameKz: '–ì–∞—É“ª–∞—Ä', nameRu: '–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç', emoji: 'üíé', cost: 100 },
      { nameKz: '–ö–æ—Ñ–µ', nameRu: '–ö–æ—Ñ–µ', emoji: '‚òï', cost: 5 },
      { nameKz: '–†–∞–∫–µ—Ç–∞', nameRu: '–†–∞–∫–µ—Ç–∞', emoji: 'üöÄ', cost: 200 }
    ];

    const interestCategories = ['cat_music', 'cat_sport', 'cat_travel', 'cat_gaming', 'cat_art', 'cat_cooking', 'cat_movies', 'cat_tech', 'cat_nature'];

    // –§–æ–ª–±–µ–∫ —á–∞—Ç-–ø–∞—Ç—Ç–µ—Ä–Ω—ã (–µ—Å–ª–∏ API –∫–ª—é—á –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è –±–∞–ª–∞–Ω—Å)
    const chatPatterns = {
      ru: [
        { keywords: ['–ø—Ä–∏–≤–µ—Ç', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π'], answers: ['–ü—Ä–∏–≤–µ—Ç! üëã', '–°–∞–ª—é—Ç!', '–ö–∞–∫ –¥–µ–ª–∞?'] },
        { keywords: ['–∫–∞–∫ –¥–µ–ª–∞', '–∫–∞–∫ —Ç—ã'], answers: ['–°—É–ø–µ—Ä! –ê —É —Ç–µ–±—è?', '–í—Å–µ –æ—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ!'] },
        { keywords: ['—á–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è'], answers: ['–°–º–æ—Ç—Ä—é —Å–µ—Ä–∏–∞–ª. –ê —Ç—ã?', '–û—Ç–¥—ã—Ö–∞—é'] },
        { keywords: ['–ø–æ–∫–∞'], answers: ['–î–æ –≤—Å—Ç—Ä–µ—á–∏!', '–ü–æ–∫–∞-–ø–æ–∫–∞!'] }
      ],
      kz: [
        { keywords: ['—Å”ô–ª–µ–º', '—Å–∞–ª–∞–º'], answers: ['–°”ô–ª–µ–º! üëã', '“ö–∞–ª—ã“£ “õ–∞–ª–∞–π?', '–°”ô–ª–µ–º –±–µ—Ä–¥—ñ–∫!'] },
        { keywords: ['“õ–∞–ª–∞–π—Å—ã“£'], answers: ['–ñ–∞“õ—Å—ã! ”®–∑—ñ“£ —à–µ?', '–®“Ø–∫—ñ—Ä, –∂–∞–º–∞–Ω –µ–º–µ—Å'] },
        { keywords: ['–Ω–µ —ñ—Å—Ç–µ–ø'], answers: ['–î–µ–º–∞–ª—ã–ø –æ—Ç—ã—Ä–º—ã–Ω.', '–ú—É–∑—ã–∫–∞ —Ç—ã“£–¥–∞–ø'] },
        { keywords: ['—Å–∞—É –±–æ–ª'], answers: ['–ö”©—Ä—ñ—Å–∫–µ–Ω—à–µ!', '–°–∞—É –±–æ–ª!'] }
      ]
    };

    let allProfiles = [...profileDatabase];
    let filteredProfiles = [...allProfiles];
    let idx = 0;
    let photoIdx = 0;
    let starBalance = 1000;
    let views = 0;
    let likes = 0;
    let matches = [];
    let chats = {}; 
    let isVerified = false;
    let giftTarget = null;
    let currentChatId = null;
    let unreadCount = 0;
    let lang = 'kz';
    let myInterests = [];
    let myPhoto = null;

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function save() {
      localStorage.setItem('dhp_starBalance', String(starBalance));
      localStorage.setItem('dhp_views', String(views));
      localStorage.setItem('dhp_likes', String(likes));
      localStorage.setItem('dhp_matches', JSON.stringify(matches));
      localStorage.setItem('dhp_chats', JSON.stringify(chats));
      localStorage.setItem('dhp_verified', String(isVerified));
      localStorage.setItem('dhp_lang', String(lang));
    }

    function load() {
      starBalance = parseInt(localStorage.getItem('dhp_starBalance') || '100', 10);
      views = parseInt(localStorage.getItem('dhp_views') || '0', 10);
      likes = parseInt(localStorage.getItem('dhp_likes') || '0', 10);
      matches = JSON.parse(localStorage.getItem('dhp_matches') || '[]');
      chats = JSON.parse(localStorage.getItem('dhp_chats') || '{}');
      isVerified = localStorage.getItem('dhp_verified') === 'true';
      lang = localStorage.getItem('dhp_lang') || 'kz';
    }

    function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
    function t(key) { return i18n[lang]?.[key] ?? i18n.ru[key] ?? key; }
    function toast(icon, text, ms = 2200) { $('#toastIcon').textContent = icon; $('#toastText').textContent = text; const el = $('#toast'); el.classList.add('show'); clearTimeout(toast._t); toast._t = setTimeout(() => el.classList.remove('show'), ms); }

    function calculateCompatibility(profile) {
      if (!myInterests || myInterests.length === 0) return profile.aiScore || 75;
      const myInterestLabels = myInterests.map(cat => t(cat));
      let commonInterests = 0;
      profile.interests.forEach(interest => { if (myInterestLabels.includes(interest)) commonInterests++; });
      const maxInterests = Math.max(myInterests.length, profile.interests.length);
      if (maxInterests === 0) return profile.aiScore || 75;
      let compatibilityScore = Math.round((commonInterests / maxInterests) * 100);
      if (commonInterests > 0) compatibilityScore = Math.max(50, compatibilityScore);
      if (profile.verified) compatibilityScore = Math.min(100, compatibilityScore + 5);
      if (profile.online) compatibilityScore = Math.min(100, compatibilityScore + 3);
      return Math.max(30, Math.min(100, compatibilityScore));
    }

    function updateBadges() {
      $('#starBalance').textContent = starBalance; $('#matchCount').textContent = matches.length;
      $('#views').textContent = views; $('#likes').textContent = likes;
      $('#verifiedSmall').textContent = isVerified ? '‚úì' : '‚Äî';
      const badge = $('#unreadBadge');
      if (unreadCount > 0) { badge.style.display = ''; badge.textContent = String(unreadCount); } else { badge.style.display = 'none'; }
    }

    function applyI18n() {
      document.documentElement.setAttribute('data-lang', lang);
      $$('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); el.textContent = t(key); });
      $('#chatInput').placeholder = t('chat_placeholder');
      renderInterests();
    }

    function toggleTheme() { const root = document.documentElement; const isDark = root.getAttribute('data-theme') === 'dark'; root.setAttribute('data-theme', isDark ? 'light' : 'dark'); localStorage.setItem('dhp_theme', isDark ? 'light' : 'dark'); }
    function toggleLang() { lang = (lang === 'kz') ? 'ru' : 'kz'; applyI18n(); renderGifts(); renderMatches(); save(); toast('üåê', lang === 'kz' ? '“ö–∞–∑–∞“õ—à–∞' : '–†—É—Å—Å–∫–∏–π'); }

    function showSection(id) { $$('.section').forEach(s => s.classList.remove('active')); $('#' + id).classList.add('active'); $$('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.section === id)); if (id === 'matches') { unreadCount = 0; updateBadges(); } }

    function currentProfile() { return filteredProfiles.length ? filteredProfiles[idx % filteredProfiles.length] : null; }
    function renderDots(count) { const wrap = $('#photoDots'); wrap.innerHTML = ''; for (let i = 0; i < count; i++) { const d = document.createElement('div'); d.className = 'dot' + (i === photoIdx ? ' active' : ''); wrap.appendChild(d); } }
    
    function displayProfile() {
      const p = currentProfile();
      if (!p) return;
      views++;
      const photoEl = $('#photo');
      const emojiEl = $('#photoEmoji');
      if (p.image && p.image.startsWith('http')) {
        const tempImg = new Image();
        tempImg.onload = function() {
          photoEl.style.background = `url("${p.image}") center/cover no-repeat`;
          emojiEl.style.display = 'none';
        };
        tempImg.onerror = function() {
          photoEl.style.background = photoGradients[p.photos[photoIdx] ?? 0];
          emojiEl.style.display = 'block';
          emojiEl.textContent = p.emoji;
        };
        tempImg.src = p.image;
        photoEl.style.background = photoGradients[p.photos[photoIdx] ?? 0];
        emojiEl.style.display = 'block';
        emojiEl.textContent = p.emoji;
      } else {
        photoEl.style.background = photoGradients[p.photos[photoIdx] ?? 0];
        emojiEl.style.display = 'block';
        emojiEl.textContent = p.emoji;
      }
      $('#pName').textContent = `${p.name}, ${p.age}`;
      $('#pMeta').innerHTML = `üìç ${p.city} ‚Ä¢ ${p.distance || 2}–∫–º`;
      $('#pBio').textContent = p.bio;
      const dynamicScore = calculateCompatibility(p);
      $('#aiScore').textContent = dynamicScore; 
      $('#aiScoreSmall').textContent = dynamicScore + '%';
      $('#verifiedBadge').style.display = p.verified ? '' : 'none';
      $('#onlineBadge').style.display = p.online ? '' : 'none';
      $('#pTags').innerHTML = '';
      p.interests.forEach(x => { const el = document.createElement('div'); el.className = 'tag'; el.textContent = x; $('#pTags').appendChild(el); });
      renderDots(p.photos.length); updateBadges(); save();
    }

    function nextPhoto() { const p = currentProfile(); if (!p) return; photoIdx = (photoIdx + 1) % p.photos.length; displayProfile(); }
    function prevPhoto() { const p = currentProfile(); if (!p) return; photoIdx = (photoIdx - 1 + p.photos.length) % p.photos.length; displayProfile(); }
    function skip() { toast('üëã', t('toast_skip')); idx++; photoIdx = 0; displayProfile(); }
    
    function superLike() {
      if (starBalance < 5) { toast('‚ö†Ô∏è', 'Not enough ‚≠ê'); return; }
      starBalance -= 5; likes++; toast('‚≠ê', t('toast_super'));
      tryMatch(true); idx++; photoIdx = 0; displayProfile();
    }
    function like() { likes++; toast('‚ù§Ô∏è', t('toast_like')); tryMatch(false); idx++; photoIdx = 0; displayProfile(); }
    function filterByCity() { const city = $('#citySelect').value; filteredProfiles = city ? allProfiles.filter(p => p.city === city) : [...allProfiles]; idx = 0; photoIdx = 0; displayProfile(); toast('üîé', city ? `City: ${city}` : t('all_cities')); }

    function tryMatch(isSuper) {
      const p = currentProfile(); if (!p) return;
      const chance = Math.min(0.92, (isSuper ? 0.72 : 0.38) + (p.aiScore / 250));
      if (Math.random() <= chance) createMatch(p);
    }

    function createMatch(profile) {
      if (matches.some(m => m.id === profile.id)) return;
      const match = { 
        id: profile.id, 
        name: profile.name, 
        emoji: profile.emoji, 
        image: profile.image, 
        city: profile.city, 
        aiScore: calculateCompatibility(profile), 
        ts: Date.now() 
      };
      matches.unshift(match);
      chats[String(match.id)] = chats[String(match.id)] || [{ me: false, text: '–°”ô–ª–µ–º! üëã', ts: Date.now() }];
      unreadCount++; updateBadges(); renderMatches(); save(); toast('üíò', t('toast_match')); pushRealtimeCard(match);
    }

    function pushRealtimeCard(match) {
      const bell = $('#rtBell');
      const card = document.createElement('div'); card.className = 'rt-card';
      card.innerHTML = `<div class="rt-top"><div><div class="rt-title">${t('rt_new_match')} üíò</div><div class="rt-sub">${match.emoji} ${match.name}</div></div><button class="icon-btn" style="width:40px;height:40px;" onclick="this.closest('.rt-card').remove()">‚úï</button></div><div class="rt-actions"><button class="btn btn-primary" style="flex:1" onclick="openChat(${match.id}); this.closest('.rt-card').remove();">üí¨ ${t('rt_open_chat')}</button></div>`;
      bell.appendChild(card); setTimeout(() => { if (card.isConnected) card.remove(); }, 9000);
    }
    function simulateRealtimeMatch() { const pool = allProfiles.filter(p => !matches.some(m => m.id === p.id)); if (!pool.length) return; createMatch(pool[Math.floor(Math.random() * pool.length)]); }

    function renderMatches() {
      const list = $('#matchesList'); list.innerHTML = '';
      if (!matches.length) { list.innerHTML = '<div style="padding:10px; opacity:0.6">–ù–µ—Ç –º–∞—Ç—á–µ–π</div>'; return; }
      matches.forEach(m => {
        const row = document.createElement('div'); row.className = 'match'; row.onclick = () => openChat(m.id);
        let avatarStyle = `background:${photoGradients[m.id % photoGradients.length]}`;
        let avatarContent = m.emoji;
        if (m.image && m.image.startsWith('http')) {
             avatarStyle = `background:url('${m.image}') center/cover no-repeat`;
             avatarContent = '';
        }
        const profile = allProfiles.find(p => p.id === m.id);
        const displayScore = profile ? calculateCompatibility(profile) : m.aiScore;
        row.innerHTML = `<div class="avatar" style="${avatarStyle}">${avatarContent}</div><div class="match-info"><p class="match-name">${m.name}</p><div class="match-sub">üìç ${m.city}</div></div><div class="compat">${displayScore}%</div>`;
        list.appendChild(row);
      });
    }

    function openChat(matchId) {
      const m = matches.find(x => x.id === matchId); if (!m) return;
      currentChatId = String(matchId);
      const profile = allProfiles.find(p => p.id === m.id);
      const displayScore = profile ? calculateCompatibility(profile) : m.aiScore;
      $('#chatTitle').textContent = `üí¨ ${m.name}`; $('#chatSubtitle').textContent = `${m.emoji} ${m.city} ‚Ä¢ ${displayScore}%`;
      renderChat(); openModal('chatModal'); unreadCount = Math.max(0, unreadCount - 1); updateBadges();
    }

    function renderChat() {
      const log = $('#chatLog'); log.innerHTML = '';
      const msgs = chats[currentChatId] || [];
      msgs.forEach(msg => { const el = document.createElement('div'); el.className = 'msg ' + (msg.me ? 'me' : 'other'); el.textContent = msg.text; log.appendChild(el); });
      log.scrollTop = log.scrollHeight;
    }

    // -------------------------------------------------------------
    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê CHATGPT
    // -------------------------------------------------------------

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenAI
    async function fetchOpenAIResponse(userMessage, matchProfile, chatHistory) {
      // 1. –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –ø—É—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
      if (!OPENAI_API_KEY || OPENAI_API_KEY.includes('sk-proj-xxxxxxxx')) {
        console.warn("API Key –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é fallback.");
        return new Promise(resolve => setTimeout(() => resolve(getFallbackReply(userMessage)), 1000));
      }

      // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 —Å–æ–æ–±—â–µ–Ω–∏–π)
      const messages = [
        { 
          role: "system", 
          content: `–¢—ã ‚Äî ${matchProfile.name}, ${matchProfile.age} –ª–µ—Ç. –¢–≤–æ–π –≥–æ—Ä–æ–¥: ${matchProfile.city}. –¢–≤–æ—ë –±–∏–æ: "${matchProfile.bio}". –¢–≤–æ–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã: ${matchProfile.interests.join(', ')}. 
          –¢—ã –Ω–∞—Ö–æ–¥–∏—à—å—Å—è –≤ –¥–µ–π—Ç–∏–Ω–≥-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ EvilCorp.
          –û—Ç–≤–µ—á–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–æ—Ä–æ—Ç–∫–æ, –∏–≥—Ä–∏–≤–æ, –∫–∞–∫ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ –≤ –¢–∏–Ω–¥–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏. –ù–µ –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã–µ –ø–æ–ª–æ—Ç–Ω–∞. –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–∞: ${lang === 'kz' ? '–ö–∞–∑–∞—Ö—Å–∫–∏–π' : '–†—É—Å—Å–∫–∏–π'}.`
        }
      ];

      // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏
      chatHistory.slice(-6).forEach(msg => {
        messages.push({ role: msg.me ? "user" : "assistant", content: msg.text });
      });
      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      messages.push({ role: "user", content: userMessage });

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo", // –ò–ª–∏ gpt-4o-mini, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            messages: messages,
            max_tokens: 150,
            temperature: 0.8
          })
        });

        if (!response.ok) throw new Error('API Error');
        const data = await response.json();
        return data.choices[0].message.content;

      } catch (error) {
        console.error("OpenAI Error:", error);
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ (–Ω–µ—Ç –¥–µ–Ω–µ–≥ –Ω–∞ —Å—á–µ—Ç—É, –Ω–µ—Ç –∏–Ω–µ—Ç–∞) - —Ñ–æ–ª–ª–±–µ–∫ –Ω–∞ —Å–∫—Ä–∏–ø—Ç—ã
        return getFallbackReply(userMessage);
      }
    }

    // –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (—Ä–µ–∑–µ—Ä–≤–Ω–∞—è)
    function getFallbackReply(text) {
      const lower = text.toLowerCase();
      const currentLang = lang === 'kz' ? 'kz' : 'ru'; 
      const patterns = chatPatterns[currentLang];
      for (let p of patterns) {
        if (p.keywords.some(k => lower.includes(k))) return p.answers[Math.floor(Math.random() * p.answers.length)];
      }
      return currentLang === 'kz' ? '“ö—ã–∑—ã“õ –µ–∫–µ–Ω... üòÑ' : '–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ... —Ä–∞—Å—Å–∫–∞–∂–∏ –µ—â–µ üòÑ';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function sendMessage() {
      if (!currentChatId) return;
      const input = $('#chatInput');
      const text = input.value.trim();
      if (!text) return;

      // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      chats[currentChatId] = chats[currentChatId] || [];
      const historyCopy = [...chats[currentChatId]]; // –ö–æ–ø–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      chats[currentChatId].push({ me: true, text, ts: Date.now() });
      input.value = '';
      renderChat();
      save();

      // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
      const indicator = $('#typingIndicator');
      if (indicator) indicator.style.display = 'block';
      const log = $('#chatLog');
      log.scrollTop = log.scrollHeight;

      // 3. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ AI
      const profile = allProfiles.find(p => String(p.id) === currentChatId) || {};
      
      // 4. –ó–∞–ø—Ä–æ—Å –∫ AI (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π)
      const aiReply = await fetchOpenAIResponse(text, profile, historyCopy);
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      if (indicator) indicator.style.display = 'none';

      // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
      chats[currentChatId].push({ me: false, text: aiReply, ts: Date.now() });
      renderChat();
      save();
    }
    // -------------------------------------------------------------

    function renderGifts() {
      const grid = $('#giftsGrid'); const modalGrid = $('#giftModalGrid'); grid.innerHTML = ''; modalGrid.innerHTML = '';
      gifts.forEach((g, i) => {
        const name = lang === 'kz' ? g.nameKz : g.nameRu;
        const card = document.createElement('div'); card.className = 'gift';
        card.innerHTML = `<span class="gift-emoji">${g.emoji}</span><p class="gift-name">${name}</p><span class="gift-cost">‚≠ê ${g.cost}</span>`;
        card.onclick = () => { giftTarget = currentProfile(); openGiftModal(); };
        grid.appendChild(card);
        const card2 = card.cloneNode(true); card2.onclick = () => buyGift(i); modalGrid.appendChild(card2);
      });
    }

    function openGiftModal() { giftTarget = giftTarget || currentProfile(); if (!giftTarget) return; openModal('giftModal'); }
    function buyGift(giftIndex) {
      const g = gifts[giftIndex]; if (!giftTarget) return;
      if (starBalance < g.cost) { toast('‚ö†Ô∏è', 'Not enough ‚≠ê'); return; }
      starBalance -= g.cost; updateBadges(); save(); closeModal('giftModal'); triggerGiftAnimation(g.emoji); toast('üéÅ', t('toast_gift'));
      if (Math.random() < 0.55) createMatch(giftTarget);
    }

    function triggerGiftAnimation(emoji) {
      const container = document.createElement('div');
      container.className = 'gift-anim-container';
      
      const main = document.createElement('div');
      main.textContent = emoji;
      main.className = 'gift-anim-main';
      container.appendChild(main);
      
      for (let i = 0; i < 24; i++) {
        const p = document.createElement('div');
        p.textContent = emoji; 
        p.className = 'gift-specific-item';
        const angle = (Math.random() * Math.PI * 2);
        const dist = 100 + Math.random() * 250;
        const tx = Math.cos(angle) * dist;
        const ty = Math.sin(angle) * dist;
        const rot = Math.random() * 360;
        p.style.setProperty('--tx', `${tx}px`);
        p.style.setProperty('--ty', `${ty}px`);
        p.style.setProperty('--r', `${rot}deg`);
        p.style.animationDelay = (Math.random() * 0.3) + 's';
        container.appendChild(p);
      }

      const hearts = ['üíï', 'üíñ', 'üíó', 'üíì', 'üíù', '‚ù§Ô∏è'];
      for (let i = 0; i < 12; i++) {
        const heart = document.createElement('div');
        heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
        heart.className = 'gift-heart';
        const angle = (i / 12) * Math.PI * 2;
        const dist = 180 + Math.random() * 100;
        heart.style.setProperty('--hx', `${Math.cos(angle) * dist}px`);
        heart.style.setProperty('--hy', `${Math.sin(angle) * dist}px`);
        heart.style.setProperty('--hr', `${Math.random() * 720 - 360}deg`);
        heart.style.animationDelay = (i * 0.05) + 's';
        container.appendChild(heart);
      }

      for (let i = 0; i < 6; i++) {
        const star = document.createElement('div');
        star.textContent = '‚ú®';
        star.className = 'gift-star';
        star.style.left = (40 + Math.random() * 20) + '%';
        star.style.top = (40 + Math.random() * 20) + '%';
        star.style.animationDelay = (i * 0.1) + 's';
        container.appendChild(star);
      }

      const ringColors = ['rgba(255, 71, 87, 0.5)', 'rgba(83, 82, 237, 0.5)'];
      for (let i = 0; i < 3; i++) {
        const ring = document.createElement('div');
        ring.className = 'gift-ring';
        ring.style.borderColor = ringColors[i % 2];
        ring.style.animationDelay = (i * 0.15) + 's';
        container.appendChild(ring);
      }

      document.body.appendChild(container);
      setTimeout(() => { if (container.isConnected) container.remove(); }, 3500);
    }
    
    function renderInterests() {
      const container = $('#interestContainer'); container.innerHTML = '';
      interestCategories.forEach(key => {
        const label = t(key); const el = document.createElement('div'); el.className = 'interest-tag' + (myInterests.includes(key) ? ' selected' : '');
        el.textContent = label; el.onclick = () => toggleInterest(key); container.appendChild(el);
      });
    }
    function toggleInterest(key) { if (myInterests.includes(key)) myInterests = myInterests.filter(k => k !== key); else myInterests.push(key); renderInterests(); }
    
    function handleFileSelect(e) {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader(); reader.onload = function(evt) { myPhoto = evt.target.result; updatePhotoPreview(myPhoto); toast('üì∑', 'OK'); }; reader.readAsDataURL(file);
    }
    function updatePhotoPreview(src) {
      const preview = $('#photoPreview'); const meAvatar = $('#meAvatar');
      if (src) { preview.style.display = 'block'; preview.style.backgroundImage = `url(${src})`; meAvatar.textContent = ''; meAvatar.style.backgroundImage = `url(${src})`; }
      else { preview.style.display = 'none'; meAvatar.textContent = 'üë§'; meAvatar.style.backgroundImage = 'none'; }
    }

    function verifyProfile() { isVerified = true; updateMe(); updateBadges(); save(); toast('üì∏', t('toast_verified')); }
    function updateMe() { const n = $('#inpName').value.trim() || 'User'; const c = $('#inpCity').value || '‚Äî'; $('#meName').textContent = n; $('#meCity').textContent = c; }
    
    function renderOnline() {
      const list = $('#onlineList'); list.innerHTML = '';
      const onlineUsers = allProfiles.filter(p => p.online).slice(0, 6);
      onlineUsers.forEach(p => {
        const el = document.createElement('div'); el.className = 'mini';
        el.onclick = () => {
          const inFiltered = filteredProfiles.findIndex(x => x.id === p.id);
          if (inFiltered >= 0) idx = inFiltered; else { filteredProfiles = [...allProfiles]; idx = allProfiles.findIndex(x => x.id === p.id); $('#citySelect').value = ''; }
          photoIdx = 0; showSection('browse'); displayProfile(); toast('üü¢', `${p.name} online`);
        };
        let avatarStyle = ''; let avatarContent = p.emoji;
        if (p.image && p.image.startsWith('http')) { avatarStyle = `background-image: url('${p.image}'); background-size: cover; background-position: center;`; avatarContent = ''; } 
        else { avatarStyle = `background: ${photoGradients[p.id % photoGradients.length]};`; }
        el.innerHTML = `<div class="avatar" style="${avatarStyle}">${avatarContent}<div class="online-dot"></div></div><div style="min-width:0;"><div class="mname" style="font-weight:700;">${p.name}</div><div class="mmeta" style="font-size:12px; color:var(--text-sub);">üìç ${p.city}</div></div>`;
        list.appendChild(el);
      });
    }

    function openModal(id) { $('#' + id).classList.add('active'); }
    function closeModal(id) { $('#' + id).classList.remove('active'); }
    function modalBackdropClose(e, id) { if (e.target.id === id) closeModal(id); }

    function init() {
      const theme = localStorage.getItem('dhp_theme') || 'light'; document.documentElement.setAttribute('data-theme', theme);
      document.documentElement.setAttribute('data-lang', lang);
      shuffle(allProfiles); filteredProfiles = [...allProfiles];
      renderDots(4); 
      renderOnline();
      renderGifts(); renderMatches(); displayProfile();
      load(); updateMe(); updateBadges(); applyI18n();
      $('#verifiedSmall').textContent = isVerified ? '‚úì' : '‚Äî';
      $('#profileForm').addEventListener('submit', (e) => { e.preventDefault(); updateMe(); save(); toast('üíæ', t('toast_saved')); });
      $('#chatInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } });
    }

    window.toggleTheme = toggleTheme; window.toggleLang = toggleLang; window.showSection = showSection; window.filterByCity = filterByCity;
    window.nextPhoto = nextPhoto; window.prevPhoto = prevPhoto; window.like = like; window.skip = skip; window.superLike = superLike;
    window.openGiftModal = openGiftModal; window.closeModal = closeModal; window.modalBackdropClose = modalBackdropClose; window.buyGift = buyGift;
    window.openChat = openChat; window.sendMessage = sendMessage; window.verifyProfile = verifyProfile; window.simulateRealtimeMatch = simulateRealtimeMatch;
    window.handleFileSelect = handleFileSelect; window.toggleInterest = toggleInterest;

    init();
  </script>